import sys
from nmapscanner import Scanner
from searchsploitanalyser import SearchsploitAnalyser
from metasploitmanager import MetasploitManager
from reportgenerator import ReportGenerator
from asciidrawer import AsciiArtPrinter

def get_target():
    if (len(sys.argv) > 1):
        target = sys.argv[1]
    else:
        print("Program requires a target specified on startup. Shutting down...")
        sys.exit(0)
    return target

def scan_target(target, output_scan_report_filename):
    output_decorated("Scanning ... Please wait")
    scanner = Scanner()
    #scan_result = scanner.Scan(target, output_scan_report_filename) #TODO uncomment
    scan_result = output_scan_report_filename 
    output_decorated("Scan done")
    return scan_result

def analyse_vulnerabilities(input_scan_results_filename, output_report_filename):
    output_decorated("Analysing scan results... Please wait")
    analyser = SearchsploitAnalyser()   
    analysis_report_filename = analyser.analyse_nmap_scan_results(input_scan_results_filename, output_report_filename)
    output_decorated("Analysis done, results saved in {0} proceeding with the exploit phase".format(analysis_report_filename))

def exploit(scan_report_path, output_report_filename):
    #TODO add other tools such as Nikto web scanner and sqlmap
    print("Further information gathering and exploatation phase has begun")
    msf = MetasploitManager()
    msf.set_targets(scan_report_path)
    msf.exploit(output_report_filename)
    print("Exploiting phase is over, final report {0} shows both failed and successful attemtps".format(output_report_filename))

def draw_ascii_banner():
    printer = AsciiArtPrinter()
    printer.draw_ascii_banner_random_font("AutoPentest")

def output_decorated(message):
    delimiter = "-"*len(message)
    print(message)
    print(delimiter)


if __name__ == "__main__":
    target = get_target()

    draw_ascii_banner()

    scan_report_name = scan_target(target,"nmap_report.xml")
 
    analyse_vulnerabilities(scan_report_name, "searchsploit_report")

    exploit(scan_report_name, "msf_report")

